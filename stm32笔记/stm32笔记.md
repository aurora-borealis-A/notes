# 一、工程模板

## 1.1 建立工程目录

工程目录结构：

- **`start`**：
  - stm32的**启动文件**（启动函数）：
    - `startup_xx.s`：
    - `system_xxx.c/.h`：
  - stm32的**寄存器定义**文件（就是一堆的宏定义）：
    - 内核寄存器定义：`core_cm3.c/.h`
    - 外设寄存器定义：`stm32f10x.h`
- **`lib`**：存储stm32的**库文件**
  - 内核库函数：`misc.h/.c`
  - 外设库函数：`stm32f10x_adc.c/.h`、`stm32f10x_can.c/.h`等。
- **`src`**：
  - 配置文件：`stm32f10x_conf.h`
  - 中断函数：`stm32f10x_it.c\.h`
  - 自定义函数：`main.c`等



## 1.2 keil中管理工程

### 1.2.1 在keil工程管理面板中复制目录层级

​		在文件夹中创建的各目录和文件与keil中工程管理面板并不是互通的，而是独立的。因此刚刚在文件夹中作了那么多修改，并不影响keil的工程管理面板（仍然是空的），为了方便管理，需要把工程目录中的文件都添加到工程管理面板中：

- 创建组：
  - 在Target1下右击：选择add group（新建组）并重命名，共添加三个组，对应工程目录下的三个文件夹；
    - `start`、`lib`、`src`
- 添加文件到组：
  - 在刚创建的组上右击（例如在src上右击）：选择`Add Existing Files to Group "src"`
  - 然后在跳出的文件选择窗口中选择组名对应的工程目录下的所有文件（按住Ctrl多选），然后点击`Add`。

### 1.2.2 配置工程选项

- 添加头文件目录：
  - 点击魔术棒按钮（Options for Target），
  - 选择c/c++选项卡，
  - 找到include Paths项：
    - 点击include Paths项中最右侧的省略号按钮，
    - 在新跳出的窗口中点击New(Insert) 按钮，
    - 再点击新建项的省略号按钮，
    - 在跳出的文件选择窗口中选择工程目录中包含头文件的目录，
    - 然后点击选择文件夹。

![](D:\!学习\笔记\notes\stm32笔记\图片\keil中添加头文件目录的方法.jpg)

- 解释：
  - 虽然我们已经把各种头文件都放入了工程目录下，而且也把这些头文件都加入到了keil的工程管理面板中，
  - 但是keil内置的编译器还是不知道哪些目录包含了头文件
    - keil只是知道了你用到了哪些头文件，
    - 但是keil并没有告诉编译器这些头文件在哪个目录下
  - 而编译器运行时（即我们执行编译时）需要知道头文件都在哪些目录，
    - 因此我们还要手动把包含头文件件的目录通过keil的选项卡告诉编译器。
  - 这确实很麻烦，但之所以这么做的理由涉及到编译器（c/c++编译器）的工作方式，所以先这么干吧。

### 1.2.3 添加宏定义

- 同样点击魔术棒按钮，再点击c/c++选项卡，
- 在Define项中输入：`USE_STDPERIPH_DRIVER`。

<img src="D:\!学习\笔记\notes\stm32笔记\图片\keil中添加宏定义.png" style="zoom:67%;" />

- 解释：

  - 这么做的效果其实跟在我们的main.c文件中的第一行添加`#define USE_STDPERIPH_DRIVER`，效果一样。

    - 只是把这个宏定义在这里而不是定义在main.c文件里是为了好看。

  - 定义这个宏的作用是启用标准外设库：

    - 我们的main.c文件中一般都会`#include"stm32f10x.h`，

    - 在stm32f10x.h中，有一段语句：

      ```c++
      #ifdef USE_STDPERIPH_DRIVER
      	#include "stm32f10x_conf.h"
      #endif
      ```

    - 而在stm32f10x_conf.h中，包含了所有标准外设库的头文件。

  - 即：

    - 如果我定义了`USE_STDPERIPH_DRIVER`，
    - 那在`stm32f10x.h`中就会包含`stm32f10x_conf.h`
    - 而`stm32f10x_conf.h`就又包含了所有外设头文件：`stm32f10x_adc.h`、`stm32f10x_can.h`等，
    - 所以这个宏的作用就是包含了所有的外设头文件。

